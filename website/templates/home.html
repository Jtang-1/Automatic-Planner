<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script>
        let autocomplete;
        function initMap(){
            visiting_area_autocomplete = create_autocomplete_visiting_area_obj("visiting_area");
            visiting_area_autocomplete.addListener('place_changed', onVisitingAreaChanged);
            console.log("Test",{{visit_place_lat}},{{visit_place_lng}});
            destination_autocomplete = create_autocomplete_obj("destination_autocomplete",{{visit_place_lat}},{{visit_place_lng}});
            destination_autocomplete.addListener('place_changed', onDestinationPlaceChanged);
            console.log("Test",{{visit_place_lat}},{{visit_place_lng}});
            home_autocomplete = create_autocomplete_obj("home_autocomplete",{{visit_place_lat}},{{visit_place_lng}});
            home_autocomplete.addListener('place_changed', onHomePlaceChanged);

        }

        function onDestinationPlaceChanged(){
            var place = destination_autocomplete.getPlace();
            if (!place.place_id){
                document.getElementById("destination_autocomplete".placeholder = "Enter a place");
            } else{
                sendInfo(place,"/receiveDestination");
            }
        }
        function onHomePlaceChanged(){
            var place = home_autocomplete.getPlace();
            if (!place.place_id){
                document.getElementById("home_autocomplete".placeholder = "Enter a place");
            } else{
                sendInfo(place,"/receiveHome");
            }
        }
        function onVisitingAreaChanged(){
            var place = visiting_area_autocomplete.getPlace();
            if (!place.place_id){
                document.getElementById("visiting_area_autocomplete".placeholder = "Enter a place");
            } else{
                sendInfo(place,"/receiveVisitingArea");
                visiting_area = place
                console.log("Test2", visiting_area)
            }
        }

        function sendInfo(place,url){
            document.getElementById("details").innerHTML = place.name;
                let location = JSON.stringify({
                    "name":place.name,
                    "place_id":place.place_id,
                    "formatted_address":place.formatted_address,
                    "type": place.types,
                    "opening_hours":place.opening_hours,
                    "business_status":place.business_status,
                    "geometry":place.geometry
                    });
                const request = new XMLHttpRequest();
                request.open("POST", url, true);
                request.send(location);
        }

        function create_autocomplete_obj(id,lat,lng){
            var sessionToken = new google.maps.places.AutocompleteSessionToken();
            var center = new google.maps.LatLng(lat,lng);
            var circle = new google.maps.Circle({
                center: center,
                radius:15000
            });
            console.log("in create object",{{visit_place_lat}},{{visit_place_lng}});
            autocomplete= new google.maps.places.Autocomplete(
                document.getElementById(id),
                {   sessionToken: sessionToken,
                    types: ["establishment"],
                    componentRestrictions: {"country": ["us"]},
                    fields: ["place_id", "name", "formatted_address", "opening_hours", "types", "business_status"]
                });
            autocomplete.setBounds(circle.getBounds());
            console.log("this is autocomplete", autocomplete);
            return autocomplete;
        }

        function create_autocomplete_visiting_area_obj(id){
            var sessionToken = new google.maps.places.AutocompleteSessionToken();
            autocomplete= new google.maps.places.Autocomplete(
                document.getElementById(id),
                {   sessionToken: sessionToken,
                    types: ["(regions)"],
                    componentRestrictions: {"country": ["us"]},
                    fields: ["place_id", "geometry"]
                });
            return autocomplete;
        }
    </script>
    <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBncbwIJ2Ug0E7oPoYubcplGGlD-dEuo98&libraries=places&callback=initMap"
    defer>
    </script>

    <form action="/" method="POST">
        <div><label for="visiting_area">Where are you visiting?</label>
        <input type="text" id="visiting_area" style="width:300px">
            <button> Submit </button>
        </div>
    </form>

    <form action="/" method="POST">
        <div> </div><label>When are you visiting?</label>
        <input type="date" id="start_date"  style="width:150px">
            through
            <input type="date" id="end_date"  style="width:150px">
        </div>
    </form>

    <form action="/" method="POST">
        <div>
        <label for="home_autocomplete">Where are you staying?</label>
        <input type="text" id="home_autocomplete"  style="width:300px">
            <button> Add </button>
        </div>
    </form>

    <form method="POST">
        <div>
        <label for="destination_autocomplete">Destination:</label>
        <input type="text" id="destination_autocomplete"  style="width:300px">
        <button> Add Location </button>
        </div>
    </form>

    <form action ="/results" method = "get">
        <input type="submit" value = "Submit">
    </form>
</head>
<body>
    <ol type="1">
        <option id="details"></option>
        {% for location in location_names %}
            <option>{{location}}</option>
        {% endfor %}
    </ol>

</body>
</html>